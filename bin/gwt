#!/usr/bin/env bash
# Git Worktree + Tmux Session Creator
# Creates a git worktree and corresponding tmux session with AI, editor, and shell windows

set -e

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Show usage
show_help() {
  cat << EOF
Usage: gwt [options] <branch-name>

Creates a git worktree in a sibling directory and sets up a tmux session with:
  - Window 1 "AI": Claude Code interactive CLI
  - Window 2: nvim editor
  - Window 3: Shell

Options:
  -d                Delete the worktree and tmux session for the specified branch
  -f                Force delete (skip unpushed commits check)
  -b <base-branch>  Branch off specified branch (default: auto-detect trunk/master/main)
  -c                Branch off current branch
  -h, --help        Show this help message

Examples:
  gwt feature-name              # Branch off trunk/master/main
  gwt feature-name -b develop   # Branch off develop branch
  gwt feature-name -c           # Branch off current branch
  gwt -d feature-name           # Delete worktree and tmux session

The worktree will be created at: ../<repo-name>-<branch-name>
The tmux session will be named: <repo-name>-<branch-name>
EOF
}

# Parse arguments
BRANCH_NAME=""
BASE_BRANCH=""
USE_CURRENT=false
DELETE_MODE=false
FORCE_DELETE=false

while [[ $# -gt 0 ]]; do
  case $1 in
    -h|--help)
      show_help
      exit 0
      ;;
    -d)
      DELETE_MODE=true
      shift
      ;;
    -f)
      FORCE_DELETE=true
      shift
      ;;
    -b)
      BASE_BRANCH="$2"
      shift 2
      ;;
    -c)
      USE_CURRENT=true
      shift
      ;;
    -*)
      echo -e "${RED}Error: Unknown option $1${NC}"
      show_help
      exit 1
      ;;
    *)
      if [[ -z "$BRANCH_NAME" ]]; then
        BRANCH_NAME="$1"
      else
        echo -e "${RED}Error: Multiple branch names provided${NC}"
        show_help
        exit 1
      fi
      shift
      ;;
  esac
done

# Validate branch name provided
if [[ -z "$BRANCH_NAME" ]]; then
  echo -e "${RED}Error: Branch name required${NC}"
  show_help
  exit 1
fi

# Check if we're in a git repository
if ! git rev-parse --git-dir > /dev/null 2>&1; then
  echo -e "${RED}Error: Not in a git repository${NC}"
  exit 1
fi

# Get current repo root and name (needed for both create and delete)
REPO_ROOT=$(git rev-parse --show-toplevel)
REPO_NAME=$(basename "$REPO_ROOT")
WORKTREE_NAME="${REPO_NAME}-${BRANCH_NAME}"
WORKTREE_PATH="$(cd "$REPO_ROOT/.." && pwd)/${WORKTREE_NAME}"

# Handle delete mode
if [[ "$DELETE_MODE" = true ]]; then
  DELETED_SOMETHING=false

  # Check for unpushed commits (unless force delete)
  if [[ "$FORCE_DELETE" = false ]]; then
    # Check if branch exists and has upstream
    if git show-ref --verify --quiet "refs/heads/$BRANCH_NAME"; then
      UPSTREAM=$(git for-each-ref --format='%(upstream:short)' "refs/heads/$BRANCH_NAME")
      if [[ -n "$UPSTREAM" ]]; then
        # Check for unpushed commits
        UNPUSHED=$(git log --oneline "$UPSTREAM..$BRANCH_NAME" 2>/dev/null)
        if [[ -n "$UNPUSHED" ]]; then
          echo -e "${RED}Error: Branch '${BRANCH_NAME}' has unpushed commits:${NC}"
          echo "$UNPUSHED"
          echo -e "${YELLOW}Use -f to force delete${NC}"
          exit 1
        fi
      else
        # No upstream, check if branch has any commits not in main branches
        for main in trunk master main; do
          if git show-ref --verify --quiet "refs/heads/$main"; then
            UNPUSHED=$(git log --oneline "$main..$BRANCH_NAME" 2>/dev/null)
            if [[ -n "$UNPUSHED" ]]; then
              echo -e "${RED}Error: Branch '${BRANCH_NAME}' has commits not in ${main}:${NC}"
              echo "$UNPUSHED"
              echo -e "${YELLOW}Use -f to force delete${NC}"
              exit 1
            fi
            break
          fi
        done
      fi
    fi
  fi

  # Kill tmux session if it exists
  if tmux has-session -t "$WORKTREE_NAME" 2>/dev/null; then
    echo -e "${YELLOW}Killing tmux session: ${WORKTREE_NAME}${NC}"
    tmux kill-session -t "$WORKTREE_NAME"
    echo -e "${GREEN}✓ Tmux session deleted${NC}"
    DELETED_SOMETHING=true
  else
    echo -e "${BLUE}No tmux session found: ${WORKTREE_NAME}${NC}"
  fi

  # Remove git worktree if it exists
  if git worktree list | grep -q "$WORKTREE_PATH"; then
    echo -e "${YELLOW}Removing worktree: ${WORKTREE_PATH}${NC}"
    git worktree remove "$WORKTREE_PATH" 2>/dev/null || git worktree remove --force "$WORKTREE_PATH"
    echo -e "${GREEN}✓ Worktree removed${NC}"
    DELETED_SOMETHING=true
  else
    echo -e "${BLUE}No worktree found: ${WORKTREE_PATH}${NC}"
  fi

  if [[ "$DELETED_SOMETHING" = false ]]; then
    echo -e "${YELLOW}Nothing to delete${NC}"
    exit 1
  fi

  exit 0
fi

# Check if tmux is installed (only needed for create mode)
if ! command -v tmux > /dev/null 2>&1; then
  echo -e "${RED}Error: tmux is not installed${NC}"
  echo "Install with: brew install tmux"
  exit 1
fi

# Check if claude is installed
if ! command -v claude > /dev/null 2>&1; then
  echo -e "${YELLOW}Warning: claude CLI not found. Install from https://code.claude.ai${NC}"
fi

# Determine base branch
if [[ "$USE_CURRENT" = true ]]; then
  BASE_BRANCH=$(git branch --show-current)
  if [[ -z "$BASE_BRANCH" ]]; then
    echo -e "${RED}Error: Not on a branch (detached HEAD)${NC}"
    exit 1
  fi
  echo -e "${BLUE}Branching off current branch: ${BASE_BRANCH}${NC}"
elif [[ -z "$BASE_BRANCH" ]]; then
  # Auto-detect main branch
  if git show-ref --verify --quiet refs/heads/trunk; then
    BASE_BRANCH="trunk"
  elif git show-ref --verify --quiet refs/heads/master; then
    BASE_BRANCH="master"
  elif git show-ref --verify --quiet refs/heads/main; then
    BASE_BRANCH="main"
  else
    echo -e "${RED}Error: Could not detect main branch (tried trunk, master, main)${NC}"
    echo "Use -b to specify a base branch or -c to use current branch"
    exit 1
  fi
  echo -e "${BLUE}Auto-detected base branch: ${BASE_BRANCH}${NC}"
else
  # Verify specified base branch exists (check both local and remote)
  if ! git show-ref --verify --quiet "refs/heads/$BASE_BRANCH" && \
     ! git show-ref --verify --quiet "refs/remotes/$BASE_BRANCH"; then
    echo -e "${RED}Error: Base branch '${BASE_BRANCH}' does not exist${NC}"
    exit 1
  fi
  echo -e "${BLUE}Using base branch: ${BASE_BRANCH}${NC}"
fi

# Check if worktree already exists
if [[ -d "$WORKTREE_PATH" ]]; then
  echo -e "${RED}Error: Worktree directory already exists: ${WORKTREE_PATH}${NC}"
  exit 1
fi

# Check if tmux session already exists
if tmux has-session -t "$WORKTREE_NAME" 2>/dev/null; then
  echo -e "${YELLOW}Warning: tmux session '${WORKTREE_NAME}' already exists${NC}"
  echo -e "${BLUE}Attaching to existing session...${NC}"
  tmux attach-session -t "$WORKTREE_NAME"
  exit 0
fi

# Create git worktree
echo -e "${GREEN}Creating worktree: ${WORKTREE_PATH}${NC}"
git worktree add -b "$BRANCH_NAME" "$WORKTREE_PATH" "$BASE_BRANCH"

# Handle Rails database symlinking
if [[ -f "$WORKTREE_PATH/bin/rails" ]]; then
  echo -e "${BLUE}Rails project detected${NC}"

  # Check if main repo has a storage directory
  if [[ -d "$REPO_ROOT/storage" ]]; then
    # Remove the newly created storage directory if it exists
    if [[ -d "$WORKTREE_PATH/storage" ]]; then
      echo -e "${YELLOW}Removing worktree storage directory${NC}"
      rm -rf "$WORKTREE_PATH/storage"
    fi

    # Copy storage from main repo
    echo -e "${GREEN}Copying storage from main repo (independent database)${NC}"
    cp -r "$REPO_ROOT/storage" "$WORKTREE_PATH/storage"
    echo -e "${GREEN}✓ Database copied to worktree${NC}"
  else
    echo -e "${YELLOW}Note: Main repo has no storage directory yet${NC}"
    echo -e "${YELLOW}Storage will be created independently in this worktree${NC}"
  fi
fi

# Handle CLAUDE-DEV.md -> CLAUDE.md setup
if [[ -f "$REPO_ROOT/CLAUDE-DEV.md" ]]; then
  echo -e "${BLUE}Setting up dev CLAUDE.md in worktree${NC}"
  cp "$REPO_ROOT/CLAUDE-DEV.md" "$WORKTREE_PATH/CLAUDE.md"
  cd "$WORKTREE_PATH"
  git update-index --skip-worktree CLAUDE.md
  cd "$REPO_ROOT"
  echo -e "${GREEN}✓ CLAUDE.md configured for dev work${NC}"
fi

# Create tmux session (detached)
echo -e "${GREEN}Creating tmux session: ${WORKTREE_NAME}${NC}"

# Create session with first window
tmux new-session -d -s "$WORKTREE_NAME" -n "AI" -c "$WORKTREE_PATH"

# Set up first window (AI)
if command -v claude > /dev/null 2>&1; then
  tmux send-keys -t "$WORKTREE_NAME:AI" "claude" C-m
else
  tmux send-keys -t "$WORKTREE_NAME:AI" "echo 'Claude CLI not installed. Install from https://code.claude.ai'" C-m
fi

# Create second window (nvim)
tmux new-window -t "$WORKTREE_NAME" -n "nvim" -c "$WORKTREE_PATH"
if command -v nvim > /dev/null 2>&1; then
  tmux send-keys -t "$WORKTREE_NAME:nvim" "nvim" C-m
else
  tmux send-keys -t "$WORKTREE_NAME:nvim" "echo 'nvim not installed'" C-m
fi

# Create third window (shell)
tmux new-window -t "$WORKTREE_NAME" -n "shell" -c "$WORKTREE_PATH"

# Select first window
tmux select-window -t "$WORKTREE_NAME:AI"

echo -e "${GREEN}✓ Worktree created at: ${WORKTREE_PATH}${NC}"
echo -e "${GREEN}✓ Tmux session created: ${WORKTREE_NAME}${NC}"
echo -e "${BLUE}To attach: tmux attach -t ${WORKTREE_NAME}${NC}"
echo -e "${BLUE}To list sessions: tmux ls${NC}"
